
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="/static/css/chat-room.css">
  <link rel="stylesheet" href="/static/css/font-awesome.all.min.css">
  <title>ç¶²é èŠå¤©å®¤</title>
  
</head>
<body>
  <div class="chat-background"></div>
  <div class="chat-container">
  <div id="sidebar">
    <h3 style="color: var(--font-color)">èŠå¤©å®¤</h3>
    <div>
      <input type="text" id="newRoomName" placeholder="æ–°èŠå¤©å®¤åç¨±">
      <button onclick="createGroup()">å»ºç«‹</button>
    </div>
    <ul style="display: inline;" id="groupList"></ul>
    <h4>åœ¨ç·šç”¨æˆ¶</h4>
    <ul style="display: inline;" id="onlineUsers"></ul>
    <div class="user-panel">
        <p>æ­¡è¿ï¼Œ{{ username }}</p>
        <div class="user-controls">
            <a href="/logout" class="control-btn">ç™»å‡º</a>
            <button onclick="new Notification('ğŸ”” é€™æ˜¯é€šçŸ¥ç¯„ä¾‹')">æ¸¬è©¦é€šçŸ¥</button>
            <button class="control-btn" onclick="showSettings()">âš™ï¸ é€²éšè¨­å®š</button>
        </div>
    </div>
  </div>
    <div id="chat" class="main-panel">
      <div id="chat-area">        
        <div id="chat-welcome" style="text-align:center; color:#888; padding: 40px 0;">
          æ­¡è¿ä¾†åˆ°ç¶²é èŠå¤©å®¤
        </div>
      </div>

      <div id="input" style="display: none;">
        <div id="messageInput" contenteditable="true"></div>
        <div id="previewImageContainer"></div>
        <button style='display: none;' onclick="sendMessage()">é€å‡º</button>
        <input type="file" id="fileInput" style="display: none;">
        <button id="uploadBtn">ä¸Šå‚³æª”æ¡ˆ</button>
      </div>
  </div>
  <div id="settings" class="main-panel" style="display: none;"></div>
  </div>
  <!-- åœ–ç‰‡æ”¾å¤§é®ç½© -->
<div id="imageModal" style="display: none; position: fixed; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.8); justify-content: center; align-items: center;">
  <img id="modalImage" style="max-width: 90%; max-height: 90%;">
</div>
</body>
</html>

<script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat-room.js') }}"></script>
<script src="{{ url_for('static', filename='js/sweetalert2.js') }}"></script>
<script>
  const username = "{{ username }}";
  const socket = io();
  const userStyle = '{{ style | tojson }}';
  const messageInput = document.getElementById('messageInput');
  const chatArea = document.getElementById('chat-area');
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');
  const roomNotificationSettings = {};
  let currentRoom = "";

  window.addEventListener('load', showEnableNotificationPrompt);

  document.addEventListener('click', () => {
    document.querySelectorAll('.room-options').forEach(opt => opt.style.display = 'none');
  });

  // ä¸Šå‚³æª”æ¡ˆæŒ‰éˆ•
  document.getElementById('uploadBtn').addEventListener('click', () => {
    document.getElementById('fileInput').click();
  });

  // ä¸Šå‚³æª”æ¡ˆåŠŸèƒ½
  document.getElementById('fileInput').addEventListener('change', function (e) {
  const file = e.target.files[0];
  e.target.value = '';
  if (!file) return;

  const formData = new FormData();
  formData.append('file', file);

  fetch('/upload_file', {
    method: 'POST',
    body: formData
  }).then(res => res.json()).then(data => {
    if (data.success) {
      socket.emit('send_message', {
        room: currentRoom,
        msg: '',
        file: data.file_url,
        filename: data.filename,
        mimetype: data.mimetype
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'æª”æ¡ˆä¸Šå‚³å¤±æ•—',
        text: 'è«‹ç¨å¾Œå†è©¦'
      });
    }
  }).catch(() => {
      Swal.fire({
        icon: 'error',
        title: 'ç¶²è·¯éŒ¯èª¤',
        text: 'æª”æ¡ˆä¸Šå‚³æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ‚¨çš„é€£ç·š'
      });
    });
  });

  // æ”¾å¤§åœ–ç‰‡åŠŸèƒ½
  let scale = 1;      // ç¸®æ”¾æ¯”ä¾‹åˆå§‹å€¼
  const scaleStep = 0.1;  // æ¯æ¬¡æ»¾è¼ªæ”¾å¤§ç¸®å°çš„å€ç‡

  // é»æ“ŠèŠå¤©å®¤å…§åœ–ç‰‡ï¼Œé–‹å•Ÿæ”¾å¤§è¦–çª—
  chatArea.addEventListener('click', function (e) {
    if (e.target.tagName === 'IMG' && e.target.closest('.message-body')) {
      scale = 1;  // é‡ç½®ç¸®æ”¾æ¯”ä¾‹
      modalImg.style.transform = `scale(${scale})`;
      modalImg.style.cursor = 'grab';
      modalImg.style.transition = 'transform 0.1s ease';
      
      modalImg.src = e.target.src;
      modal.style.display = 'flex';
    }
  });

  // é»æ“Šé®ç½©é—œé–‰æ”¾å¤§åœ–ç‰‡è¦–çª—
  modal.addEventListener('click', function () {
    modal.style.display = 'none';
  });

  // æ»¾è¼ªæ§åˆ¶ç¸®æ”¾
  modalImg.addEventListener('wheel', function (e) {
    e.preventDefault();

    if (e.deltaY < 0) {
      // æ»¾è¼ªå‘ä¸Šï¼Œæ”¾å¤§
      scale += scaleStep;
    } else {
      // æ»¾è¼ªå‘ä¸‹ï¼Œç¸®å°ï¼ˆæœ€å°åˆ° 0.5ï¼‰
      scale = Math.max(scaleStep, scale - scaleStep);
    }

    modalImg.style.transform = `scale(${scale})`;
  });
  // Enteréµé€å‡ºè¨Šæ¯
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault(); // é˜»æ­¢é è¨­æ›è¡Œè¡Œç‚º
      sendMessage();
    }
  })
    // åˆå§‹åŒ–èŠå¤©å®¤æ¸…å–®
    fetch('/get_rooms')
      .then(res => res.json())
      .then(data => data.rooms.forEach(addRoomToList));

    socket.emit('login', { username });

    // åœ¨ç·šç”¨æˆ¶æ›´æ–°
    socket.on('update_users', function(users) {
      onlineUsers.innerHTML = '';

      users
        .filter(user => user !== username) // âœ… æ’é™¤è‡ªå·±
        .forEach(user => {
          const room = privateRoomName(username, user);
          const isNotified = localStorage.getItem(`notify_${room}`) !== 'off';
          const bellIcon = isNotified ? 'fa-bell' : 'fa-bell-slash';

          const li = document.createElement('li');
          li.setAttribute('data-room', room);
          li.style.display = 'flex';
          li.style.alignItems = 'center';
          li.style.padding = '4px 8px';

          li.innerHTML = `
            <i class="fa-solid ${bellIcon} notify-toggle"
              title="åˆ‡æ›é€šçŸ¥"
              style="cursor: pointer; color: var(--font-color); margin: 10px;"
              data-room="${room}"></i>
            <span class="private-name" style="cursor: default; color: var(--font-color);">
              ${user}
            </span>
          `;

          // é»æ“Šç§èŠç”¨æˆ¶åç¨± â†’ é€²å…¥ç§èŠæˆ¿é–“
          li.addEventListener('click', (e) => {
            if (e.target.classList.contains('notify-toggle')) return; // é»åˆ°éˆ´éºä¸åˆ‡æ›æˆ¿é–“
            clearActiveStatus();
            setActiveUser(user);
            joinRoom(room);
          });

          // é»æ“Šéˆ´éºåˆ‡æ›é€šçŸ¥ç‹€æ…‹
          li.querySelector('.notify-toggle').addEventListener('click', (e) => {
            const icon = e.target;
            const room = icon.dataset.room;
            const isOn = icon.classList.contains('fa-bell');

            if (isOn) {
              icon.classList.remove('fa-bell');
              icon.classList.add('fa-bell-slash');
              localStorage.setItem(`notify_${room}`, 'off');
            } else {
              icon.classList.remove('fa-bell-slash');
              icon.classList.add('fa-bell');
              localStorage.setItem(`notify_${room}`, 'on');
            }
          });

          onlineUsers.appendChild(li);
        });
    });

    // è¨Šæ¯é¡¯ç¤º
    let originalTitle = document.title;
    let blinkInterval;

    function startBlink() {
      let isBlink = false;
      blinkInterval = setInterval(() => {
        document.title = isBlink ? 'ã€æ–°è¨Šæ¯ã€‘ç¶²é èŠå¤©å®¤' : originalTitle;
        isBlink = !isBlink;
      }, 800);
    }

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        document.title = originalTitle;
        clearInterval(blinkInterval);
      }
    });
    socket.on('message', function(data) {
      const m = document.createElement('div');
      m.classList.add('message');

      const header = document.createElement('div');
      header.classList.add('message-header');
      header.innerHTML = `<b>${escapeHTML(data.user)}</b> (${data.timestamp}):`;

      const body = document.createElement('div');
      body.classList.add('message-body');

      if (data.file) {
        if (data.mimetype && data.mimetype.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = escapeHTML(data.file);
          img.style.maxWidth = '500px';
          img.style.maxHeight = '500px';
          body.appendChild(img);
        } else {
          // å°æ‡‰å‰¯æª”å => Font Awesome åœ–ç¤º class
          const ext = data.filename.split('.').pop().toLowerCase();
          const iconClassMap = {
            'zip': 'fa-file-zipper',
            'rar': 'fa-file-zipper',
            'pdf': 'fa-file-pdf',
            'doc': 'fa-file-word',
            'docx': 'fa-file-word',
            'txt': 'fa-file-lines',
            'ppt': 'fa-file-powerpoint',
            'pptx': 'fa-file-powerpoint',
            'xls': 'fa-file-excel',
            'xlsx': 'fa-file-excel',
            'mp3': 'fa-file-audio',
            'wav': 'fa-file-audio',
            'mp4': 'fa-file-video',
            'mov': 'fa-file-video',
            'apk': 'fa-mobile',
            'exe': 'fa-file',
            'default': 'fa-paperclip'
          };

          const iconClass = iconClassMap[ext] || iconClassMap['default'];

          const icon = document.createElement('i');
          icon.className = `fa-solid ${iconClass}`;
          icon.style.marginRight = '8px';

          const a = document.createElement('a');
          a.href = escapeHTML(data.file);
          a.download = data.filename;
          a.textContent = `ä¸‹è¼‰æª”æ¡ˆï¼š${data.filename}`;
          a.target = '_blank';

          body.appendChild(icon);
          body.appendChild(a);
        }
      } else {
        body.innerText = data.msg;
      }

      m.appendChild(header);
      m.appendChild(body);
      chatArea.appendChild(m);
      chatArea.scrollTop = chatArea.scrollHeight;
    });

    function showEnableNotificationPrompt() {
      if (!('Notification' in window)) return;

      if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
        Swal.fire({
          title: 'å•Ÿç”¨èŠå¤©å®¤é€šçŸ¥ï¼Ÿ',
          text: 'å…è¨±é€šçŸ¥å¾Œï¼Œå³ä½¿åˆ‡æ›åˆ†é ä»å¯æ”¶åˆ°æ–°è¨Šæ¯æé†’ã€‚',
          icon: 'info',
          showCancelButton: true,
          confirmButtonText: 'å•Ÿç”¨',
          cancelButtonText: 'ç¨å¾Œ',
        }).then(result => {
          if (result.isConfirmed) {
            enableNotifications();
          }
        });
      }
    }

    function enableNotifications() {
      if (!('Notification' in window)) {
        alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥åŠŸèƒ½');
        return;
      }
      if (Notification.permission === 'granted') {
        Swal.fire({
          icon: 'success',
          title: 'é€šçŸ¥åŠŸèƒ½å·²å•Ÿç”¨',
          showConfirmButton: false,
          timer: 1500
        });
      } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            Swal.fire({
              icon: 'success',
              title: 'é€šçŸ¥åŠŸèƒ½å·²å•Ÿç”¨',
              showConfirmButton: false,
              timer: 1500
            });
          }
        });
      }
    }
    function renameRoomInNotifySettings(oldName, newName) {
      const status = localStorage.getItem(`notify_${oldName}`);
      if (status !== null) {
        localStorage.setItem(`notify_${newName}`, status);
        localStorage.removeItem(`notify_${oldName}`);
      }
    }
    function removeRoomFromNotifySettings(roomName) {
      const settings = JSON.parse(localStorage.getItem(`notify_${roomName}`)) || {};
      if (settings.hasOwnProperty(roomName)) {
        delete settings[roomName];
        localStorage.setItem(`notify_${roomName}`, JSON.stringify(settings));
      }
    }
    // å»ºç«‹èŠå¤©å®¤
    function createGroup() {
      const name = document.getElementById('newRoomName').value.trim();
      if (!name) return  Swal.fire({icon: 'error',title: 'å»ºç«‹èŠå¤©å®¤å¤±æ•—',text: 'è«‹è¼¸å…¥èŠå¤©å®¤åç¨±',showConfirmButton: false,timer: 1500});
      document.getElementById('newRoomName').value = "";
      socket.emit('create_group', { name });
    }

    function joinRoom(room) {
      // æ¸…é™¤æ­¡è¿ç•«é¢
      const welcome = document.getElementById('chat-welcome');
      if (welcome) welcome.remove();

      // é¡¯ç¤ºè¼¸å…¥å€å¡Š
      document.getElementById('input').style.display = 'flex';

      // æ¸…ç©ºè¨Šæ¯å€
      chatArea.innerHTML = '';

      // åŠ å…¥ Socket æˆ¿é–“
      socket.emit('join_room', { room });

      // æ¨™è¨˜èŠå¤©å®¤ç‚º active
      const roomLi = groupList.querySelector(`li[data-room="${room}"]`);
      if (roomLi) roomLi.classList.add('active');

      // å¦‚æœè©²èŠå¤©å®¤æ²’è¨­å®šéï¼Œå°±é è¨­é–‹å•Ÿé€šçŸ¥
      if (!(room in roomNotificationSettings)) {
        roomNotificationSettings[room] = true;
      }
    }

    function showSettings() {
      fetch('/setting')
        .then(res => res.text())
        .then(html => {
          document.getElementById('settings').innerHTML = html;
          document.getElementById('chat').style.display = 'none';
          document.getElementById('settings').style.display = 'block';
          initSettings();
        });
    }

    // ç§èŠæˆ¿é–“å‘½å
    function privateRoomName(user1, user2) {
      return 'pm-' + [user1, user2].sort().join('-');
    }

    // æ–°å¢èŠå¤©å®¤é …ç›®
  function addRoomToList(name) {
    const li = document.createElement('li');
    li.setAttribute('data-room', name);
    li.style.position = 'relative';
    li.style.display = 'flex';
    li.style.justifyContent = 'space-between';
    li.style.alignItems = 'center';
    li.style.padding = '4px 8px';
    const isNotified = localStorage.getItem(`notify_${name}`) !== 'off';
    const bellIcon = isNotified ? 'fa-bell' : 'fa-bell-slash';
    li.innerHTML = `
      <span style="display: flex; align-items: center; gap: 8px;">
      <i class="fa-solid ${bellIcon} bell-toggle" title="é€šçŸ¥é–‹é—œ" style="cursor: pointer; color: var(--font-color);"></i>
      </span> 
      <span class="room-name" style="color: var(--font-color); cursor: default;">${name}</span>
      <button class="room-menu-btn" style="color: #ffffff" onclick="toggleRoomOptions(event, this)">â‹®</button>
      <div class="room-options" style="display:none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid #ccc; z-index: 10;">
        <button style="color: var(--font-color)" onclick="renameRoom(this, '${name}')">é‡æ–°å‘½åèŠå¤©å®¤</button>
        <button style="color: var(--font-color)" onclick="deleteRoom('${name}')">åˆªé™¤èŠå¤©å®¤</button>
      </div>
    `;

    li.addEventListener('click', (e) => {
      if (e.target.closest('.room-menu-btn') || e.target.closest('.room-options')) return;
      clearActiveStatus();
      li.classList.add('active');
      const roomName = li.dataset.room;  // â† é€™è£¡æ”¹æˆè®€å–ç›®å‰å±¬æ€§
      joinRoom(roomName);
    });

    // é»æ“Šéˆ´éºåˆ‡æ›é€šçŸ¥ç‹€æ…‹
    li.querySelector('.bell-toggle').addEventListener('click', (e) => {
      e.stopPropagation();  // é¿å…è§¸ç™¼çˆ¶å…ƒç´ çš„ click äº‹ä»¶
      const icon = e.target;
      const isNowOn = icon.classList.contains('fa-bell');
      if (isNowOn) {
        icon.classList.remove('fa-bell');
        icon.classList.add('fa-bell-slash');
        // å„²å­˜é€šçŸ¥ç‹€æ…‹ç‚ºé—œé–‰ï¼ˆä¾‹å¦‚ localStorage æˆ–è®Šæ•¸ï¼‰
        localStorage.setItem(`notify_${name}`, 'off');
      } else {
        icon.classList.remove('fa-bell-slash');
        icon.classList.add('fa-bell');
        // å„²å­˜é€šçŸ¥ç‹€æ…‹ç‚ºé–‹å•Ÿ
        localStorage.setItem(`notify_${name}`, 'on');
      }
    });

    document.getElementById('groupList').appendChild(li);
  }

  function toggleRoomOptions(event, button) {
    event.stopPropagation();
    const options = button.nextElementSibling;

    // å¦‚æœé€™å€‹æ˜¯ç›®å‰å·²ç¶“é–‹å•Ÿçš„ï¼Œå°±é—œé–‰
    const isVisible = options.style.display === 'block';

    // é—œé–‰æ‰€æœ‰ä¸‹æ‹‰é¸å–®
    document.querySelectorAll('.room-options').forEach(opt => opt.style.display = 'none');

    // å¦‚æœåŸæœ¬æ˜¯é—œé–‰çš„ï¼Œå‰‡æ‰“é–‹
    if (!isVisible) {
      options.style.display = 'block';
    }
  }

  function renameRoom(button, oldName) {
    const newName = prompt("è«‹è¼¸å…¥æ–°çš„èŠå¤©å®¤åç¨±", oldName);
    if (!newName || newName === oldName) return;

    fetch('/rename_room', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ old_name: oldName, new_name: newName })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // æ›´æ–°èŠå¤©å®¤æ¸…å–®é¡¯ç¤º
        const li = button.closest('li');
        li.setAttribute('data-room', newName);
        li.querySelector('.room-name').textContent = newName;

        // âœ… è‹¥ä½¿ç”¨è€…æ­£åœ¨é€™å€‹æˆ¿é–“ï¼Œæ›´æ–° currentRoom
        if (currentRoom === oldName) {
          currentRoom = newName;
          joinRoom(newName);
        }
        renameRoomInNotifySettings(oldName, newName);
        const optionsDiv = li.querySelector('.room-options');
        const buttons = optionsDiv.querySelectorAll('button');
        buttons.forEach(btn => {
          if (btn.textContent.includes('é‡æ–°å‘½å')) {
            btn.setAttribute('onclick', `renameRoom(this, '${newName}')`);
          } else if (btn.textContent.includes('åˆªé™¤')) {
            btn.setAttribute('onclick', `deleteRoom('${newName}')`);
          }
        });
        Swal.fire({
          icon: 'success',
          title: 'èŠå¤©å®¤åç¨±å·²æ›´æ–°',
          showConfirmButton: false,
          timer: 1500
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'èŠå¤©å®¤æ”¹åå¤±æ•—',
          text: 'è«‹ç¨å¾Œå†è©¦'
        });
      }
    });
  }
  function deleteRoom(name) {
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤èŠå¤©å®¤ "${name}"ï¼Ÿé€™å°‡åˆªé™¤æ‰€æœ‰è¨Šæ¯ã€‚`)) return;

    fetch('/delete_room', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    }).then(res => res.json()).then(data => {
      if (data.success) {
        removeRoomFromNotifySettings(name);
        Swal.fire({
          icon: 'success',
          title: `${name}èŠå¤©å®¤å·²åˆªé™¤`,
          showConfirmButton: false,
          timer: 1500
        }).then(() => {
          location.reload();
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: `${name}èŠå¤©å®¤åˆªé™¤å¤±æ•—`,
          text: 'è«‹ç¨å¾Œå†è©¦'
        });
      }
    });
  }

  // æ–°èŠå¤©å®¤é€šçŸ¥
  socket.on('group_created', function(data) {
    addRoomToList(data.name);
  });

  // æ¸…é™¤æ‰€æœ‰ active æ¨£å¼
  function clearActiveStatus() {
    document.querySelectorAll('#groupList li, #onlineUsers li').forEach(li => {
      li.classList.remove('active');
    });
  }

  // è¨­å®šæŸå€‹ä½¿ç”¨è€…ç‚º active
  function setActiveUser(user) {
    const listItems = onlineUsers.querySelectorAll('#onlineUsers li');
    const target = Array.from(listItems).find(li => li.textContent.trim() === user);
    if (target) target.classList.add('active');
    
  }
  let pastedImageFile = null;

  document.getElementById('messageInput').addEventListener('paste', function (e) {
    const items = e.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      if (item.type.indexOf("image") !== -1) {
        const file = item.getAsFile();
        const reader = new FileReader();
        reader.onload = function (event) {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.style.maxWidth = '200px';
          img.style.maxHeight = '200px';
          img.contentEditable = true;

          const selection = window.getSelection();
          if (!selection.rangeCount) return;
          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(img);

          // åœ¨åœ–ç‰‡å¾Œé¢æ’å…¥ç©ºæ ¼æ¸¸æ¨™
          range.setStartAfter(img);
          range.setEndAfter(img);
          selection.removeAllRanges();
          selection.addRange(range);
        };
        reader.readAsDataURL(file);
        e.preventDefault();
      }
    }
  });

  function sendMessage() {
    const inputDiv = document.getElementById('messageInput');
    const nodes = Array.from(inputDiv.childNodes);

    // éé€å…§å®¹çš„é †åº
    function processNode(index) {
      if (index >= nodes.length) {
        inputDiv.innerHTML = '';
        return;
      }

      const node = nodes[index];

      if (node.nodeType === Node.TEXT_NODE ) {
        const text = node.textContent.trim();
        if (text) {
          socket.emit('send_message', {
            room: currentRoom,
            msg: text
          });
        }
        processNode(index + 1); // ç¹¼çºŒè™•ç†ä¸‹ä¸€å€‹ç¯€é»
      }
      // else if(node.nodeType === Node.ELEMENT_NODE){
      //     // å…¶ä»–æ¨™ç±¤ï¼ˆdiv, pre, span, br, strong...ï¼‰â€” å–å‡ºå…¶æ–‡å­—å…§å®¹
      //     const text = node.innerText || node.textContent || '';
      //     const trimmed = text.trim();
      //     if (trimmed) {
      //       socket.emit('send_message', {
      //         room: currentRoom,
      //         msg: trimmed
      //       });
      //     }
      //     processNode(index + 1); // ç¹¼çºŒè™•ç†ä¸‹ä¸€å€‹ç¯€é»
      // }
      
      else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'IMG') {
        const img = node;
        if (img.src.startsWith('data:image/')) {
          const blob = dataURLtoBlob(img.src);
          const formData = new FormData();
          formData.append('file', blob, 'pasted.png');

          fetch('/upload_file', {
            method: 'POST',
            body: formData
          }).then(res => res.json()).then(data => {
            if (data.success) {
              socket.emit('send_message', {
                room: currentRoom,
                msg: '',
                file: data.file_url,
                filename: data.filename,
                mimetype: data.mimetype
              });
            }
            processNode(index + 1); // ç­‰åœ–ç‰‡ä¸Šå‚³å®Œæ‰è™•ç†ä¸‹ä¸€å€‹
          });
        } else {
          processNode(index + 1);
        }
      }

      else {
        // å¿½ç•¥å…¶ä»–å…ƒç´ 
        processNode(index + 1);
      }
    }

    processNode(0); // å¾ç¬¬ä¸€å€‹é–‹å§‹éé€
  }
  
  function dataURLtoBlob(dataurl) {
    const arr = dataurl.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) {
      u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], { type: mime });
  }

  function escapeHTML(str) {
    const div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }

  (function applySettingsOnLoad() {
      const settings = JSON.parse(localStorage.getItem('chatSettings') || '{}');

      if (settings.bgType === 'image' && settings.bgImage) {
        document.body.style.background = `url(${settings.bgImage}) center/cover no-repeat`;
      } else if (settings.bgColor) {
        document.body.style.background = settings.bgColor;
      }

      if (settings.blurValue) {
        document.body.style.backdropFilter = `blur(${settings.blurValue}px)`;
      }

      if (settings.fontColor) {
        document.documentElement.style.setProperty('--font-color', settings.fontColor);
      }
      updateSidebarColor(settings.bgColor || '#ffffff');
    })();

  function applyUserStyle(style) {
    if(style.custom_bg && style.custom_bg !== ''){
      document.body.style.background = `url(${style.custom_bg}) center/cover`;
    } else {
      document.body.style.background = style.bg_color;
    }

    document.body.style.backdropFilter = `blur(${style.blur || 0}px)`;
    document.body.style.color = style.font_color;
  }

  applyUserStyle(userStyle);
</script>
