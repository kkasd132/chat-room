
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="/static/css/chat-room.css">
  <title>網頁聊天室</title>
  
</head>
<body>
  <div class="chat-background"></div>
  <div class="chat-container">
  <div id="sidebar">
    <h3 style="color: var(--font-color)">聊天室</h3>
    <div>
      <input type="text" id="newRoomName" placeholder="新聊天室名稱">
      <button onclick="createGroup()">建立</button>
    </div>
    <ul id="groupList"></ul>
    <h4>在線用戶</h4>
    <ul id="onlineUsers"></ul>
    <div class="user-panel">
        <p>歡迎，{{ username }}</p>
        <div class="user-controls">
            <a href="/logout" class="control-btn">登出</a>
            <button class="control-btn" onclick="showSettings()">⚙️ 進階設定</button>
        </div>
    </div>
  </div>
    <div id="chat" class="main-panel">
      <div id="chat-area">        
        <div id="chat-welcome" style="text-align:center; color:#888; padding: 40px 0;">
          歡迎來到網頁聊天室
        </div>
      </div>

      <div id="input" style="display: none;">
        <div id="messageInput" contenteditable="true"></div>
        <div id="previewImageContainer"></div>
        <button style='display: none;' onclick="sendMessage()">送出</button>
        <input type="file" id="imageInput" style="display: none;">
        <button id="uploadBtn">上傳圖片</button>
      </div>
  </div>
  <div id="settings" class="main-panel" style="display: none;"></div>
  </div>
</body>
</html>

<script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat-room.js') }}"></script>
<script>
  const username = "{{ username }}";
  const socket = io();
  const userStyle = '{{ style | tojson }}';
  const messageInput = document.getElementById('messageInput');
  const chatArea = document.getElementById('chat-area');
  let currentRoom = "";
  document.addEventListener('click', () => {
    document.querySelectorAll('.room-options').forEach(opt => opt.style.display = 'none');
  });

  // 上傳圖片按鈕
  document.getElementById('uploadBtn').addEventListener('click', () => {
    document.getElementById('imageInput').click();
  });

  // 上傳圖片功能
  document.getElementById('imageInput').addEventListener('change', function (e) {
    const file = e.target.files[0];
    e.target.value = '';
    if (!file) return;

    const formData = new FormData();
    formData.append('image', file);

    fetch('/upload_image', {
      method: 'POST',
      body: formData
    }).then(res => res.json()).then(data => {
      if (data.success) {
        socket.emit('send_message', {
          room: currentRoom,
          msg: '',
          image: data.url
        });
      } else {
        alert(data.message || '圖片上傳失敗');
      }
    }).catch(() => alert('圖片上傳錯誤'));
  });
  // Enter鍵送出訊息
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault(); // 阻止預設換行行為
      sendMessage();
    }
  })
    // 初始化聊天室清單
    fetch('/get_rooms')
      .then(res => res.json())
      .then(data => data.rooms.forEach(addRoomToList));

    socket.emit('login', { username });

    // 在線用戶更新
    socket.on('update_users', function(users) {
      onlineUsers.innerHTML = '';
      users
        .filter(user => user !== username) // ✅ 排除自己
        .forEach(user => {
          const li = document.createElement('li');
          li.textContent = user;
          li.onclick = () => {
            const room = privateRoomName(username, user);
            clearActiveStatus();
            setActiveUser(user);
            joinRoom(room);
          };
          onlineUsers.appendChild(li);
        });
    });

    // 訊息顯示
    let originalTitle = document.title;
    let blinkInterval;

    function startBlink() {
      let isBlink = false;
      blinkInterval = setInterval(() => {
        document.title = isBlink ? '【新訊息】網頁聊天室' : originalTitle;
        isBlink = !isBlink;
      }, 800);
    }

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        document.title = originalTitle;
        clearInterval(blinkInterval);
      }
    });

    socket.on('message', function(data) {
      const m = document.createElement('div');
      m.classList.add('message');

      // 左側：使用者名稱與時間（獨立一行）
      const header = document.createElement('div');
      header.classList.add('message-header');
      header.innerHTML = `<b>${escapeHTML(data.user)}</b> (${data.timestamp}):`;

      // 右側：訊息本體
      const body = document.createElement('div');
      body.classList.add('message-body');

      if (data.image) {
        const img = document.createElement('img');
        img.src = escapeHTML(data.image);
        img.style.maxWidth = '500px';
        img.style.maxHeight = '500px';
        body.appendChild(img);
      } else {
        body.innerText = data.msg; // 多行文字，自動保留換行
      }

      m.appendChild(header);
      m.appendChild(body);
      chatArea.appendChild(m);
      chatArea.scrollTop = chatArea.scrollHeight;
    });

    function enableNotifications() {
      if (!('Notification' in window)) {
        alert('此瀏覽器不支援通知功能');
        return;
      }
      if (Notification.permission === 'granted') {
        alert('通知功能已啟用');
      } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            alert('通知功能已啟用');
          }
        });
      }
    }

    // 建立聊天室
    function createGroup() {
      const name = document.getElementById('newRoomName').value.trim();
      if (!name) return alert("請輸入聊天室名稱");
      document.getElementById('newRoomName').value = "";
      socket.emit('create_group', { name });
    }

    // 加入房間
    // function joinRoom(room) {
    //   currentRoom = room;
    //   chatArea.innerHTML = '';
    //   socket.emit('join_room', { room });
      
    //   //clearActiveStatus();

    //   const roomLi = groupList.querySelector(`li[data-room="${room}"]`);
    //   if (roomLi) roomLi.classList.add('active');
    // }
    function joinRoom(room) {
      currentRoom = room;

      // 清除歡迎畫面
      const welcome = document.getElementById('chat-welcome');
      if (welcome) welcome.remove();

      // 顯示輸入區塊
      document.getElementById('input').style.display = 'flex';

      // 清空訊息區
      chatArea.innerHTML = '';

      // 加入 Socket 房間
      socket.emit('join_room', { room });

      // 標記聊天室為 active
      const roomLi = groupList.querySelector(`li[data-room="${room}"]`);
      if (roomLi) roomLi.classList.add('active');
    }
    function showSettings() {
      fetch('/setting')
        .then(res => res.text())
        .then(html => {
          document.getElementById('settings').innerHTML = html;
          document.getElementById('chat').style.display = 'none';
          document.getElementById('settings').style.display = 'block';
          initSettings();
        });
    }

    // 私聊房間命名
    function privateRoomName(user1, user2) {
      return 'pm-' + [user1, user2].sort().join('-');
    }

    // 新增聊天室項目
  function addRoomToList(name) {
    const li = document.createElement('li');
    li.setAttribute('data-room', name);
    li.style.position = 'relative';
    li.style.display = 'flex';
    li.style.justifyContent = 'space-between';
    li.style.alignItems = 'center';
    li.style.padding = '4px 8px';

    li.innerHTML = `
      <span class="room-name" style="color: var(--font-color)">${name}</span>
      <button class="room-menu-btn" style="color: #ffffff" onclick="toggleRoomOptions(event, this)">⋮</button>
      <div class="room-options" style="display:none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid #ccc; z-index: 10;">
        <button style="color: var(--font-color)" onclick="renameRoom(this, '${name}')">重新命名聊天室</button>
        <button style="color: var(--font-color)" onclick="deleteRoom('${name}')">刪除聊天室</button>
      </div>
    `;

    // li.addEventListener('click', (e) => {
    //   if (e.target.closest('.room-menu-btn') || e.target.closest('.room-options')) return;
    //   clearActiveStatus();
    //   li.classList.add('active');
    //   joinRoom(name);
    // });
    li.addEventListener('click', (e) => {
  if (e.target.closest('.room-menu-btn') || e.target.closest('.room-options')) return;
  clearActiveStatus();
  li.classList.add('active');
  const roomName = li.dataset.room;  // ← 這裡改成讀取目前屬性
  joinRoom(roomName);
});
    document.getElementById('groupList').appendChild(li);
  }

  function toggleRoomOptions(event, button) {
    event.stopPropagation();
    const options = button.nextElementSibling;

    // 如果這個是目前已經開啟的，就關閉
    const isVisible = options.style.display === 'block';

    // 關閉所有下拉選單
    document.querySelectorAll('.room-options').forEach(opt => opt.style.display = 'none');

    // 如果原本是關閉的，則打開
    if (!isVisible) {
      options.style.display = 'block';
    }
  }

  function renameRoom(button, oldName) {
    const newName = prompt("請輸入新的聊天室名稱", oldName);
    if (!newName || newName === oldName) return;

    fetch('/rename_room', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ old_name: oldName, new_name: newName })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // 更新聊天室清單顯示
        const li = button.closest('li');
        li.setAttribute('data-room', newName);
        li.querySelector('.room-name').textContent = newName;

        // ✅ 若使用者正在這個房間，更新 currentRoom
        if (currentRoom === oldName) {
          currentRoom = newName;
          joinRoom(newName);
        }

        alert("聊天室名稱已更新");
      } else {
        alert(data.message || "聊天室改名失敗");
      }
    });
  }
    function deleteRoom(name) {
      if (!confirm(`確定要刪除聊天室 "${name}"？這將刪除所有訊息。`)) return;

      fetch('/delete_room', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      }).then(res => res.json()).then(data => {
        if (data.success) {
          alert('聊天室已刪除');
          location.reload();
        } else {
          alert(data.message || '刪除失敗');
        }
      });
    }

    // 新聊天室通知
    socket.on('group_created', function(data) {
      addRoomToList(data.name);
    });

    // 清除所有 active 樣式
    function clearActiveStatus() {
      document.querySelectorAll('#groupList li, #onlineUsers li').forEach(li => {
        li.classList.remove('active');
      });
    }

    // 設定某個使用者為 active
    function setActiveUser(user) {
      const listItems = onlineUsers.querySelectorAll('#onlineUsers li');
      const target = Array.from(listItems).find(li => li.textContent.trim() === user);
      if (target) target.classList.add('active');
      
    }
    let pastedImageFile = null;

  document.getElementById('messageInput').addEventListener('paste', function (e) {
    const items = e.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      if (item.type.indexOf("image") !== -1) {
        const file = item.getAsFile();
        const reader = new FileReader();
        reader.onload = function (event) {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.style.maxWidth = '200px';
          img.style.maxHeight = '200px';
          img.contentEditable = true;

          const selection = window.getSelection();
          if (!selection.rangeCount) return;
          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(img);

          // 在圖片後面插入空格游標
          range.setStartAfter(img);
          range.setEndAfter(img);
          selection.removeAllRanges();
          selection.addRange(range);
        };
        reader.readAsDataURL(file);
        e.preventDefault();
      }
    }
  });

function sendMessage() {
  const inputDiv = document.getElementById('messageInput');
  const nodes = Array.from(inputDiv.childNodes);

  // 遞送內容的順序
  function processNode(index) {
    if (index >= nodes.length) {
      inputDiv.innerHTML = '';
      return;
    }

    const node = nodes[index];

    if (node.nodeType === Node.TEXT_NODE ) {
      const text = node.textContent.trim();
      if (text) {
        socket.emit('send_message', {
          room: currentRoom,
          msg: text
        });
      }
      processNode(index + 1); // 繼續處理下一個節點
    }
    // else if(node.nodeType === Node.ELEMENT_NODE){
    //     // 其他標籤（div, pre, span, br, strong...）— 取出其文字內容
    //     const text = node.innerText || node.textContent || '';
    //     const trimmed = text.trim();
    //     if (trimmed) {
    //       socket.emit('send_message', {
    //         room: currentRoom,
    //         msg: trimmed
    //       });
    //     }
    //     processNode(index + 1); // 繼續處理下一個節點
    // }
    
    else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'IMG') {
      const img = node;
      if (img.src.startsWith('data:image/')) {
        const blob = dataURLtoBlob(img.src);
        const formData = new FormData();
        formData.append('image', blob, 'pasted.png');

        fetch('/upload_image', {
          method: 'POST',
          body: formData
        }).then(res => res.json()).then(data => {
          if (data.success) {
            socket.emit('send_message', {
              room: currentRoom,
              msg: '',
              image: data.url
            });
          }
          processNode(index + 1); // 等圖片上傳完才處理下一個
        });
      } else {
        processNode(index + 1);
      }
    }

    else {
      // 忽略其他元素
      processNode(index + 1);
    }
  }

  processNode(0); // 從第一個開始遞送
}
    function dataURLtoBlob(dataurl) {
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], { type: mime });
    }
    function escapeHTML(str) {
      const div = document.createElement('div');
      div.appendChild(document.createTextNode(str));
      return div.innerHTML;
    }
    (function applySettingsOnLoad() {
      const settings = JSON.parse(localStorage.getItem('chatSettings') || '{}');

      if (settings.bgType === 'image' && settings.bgImage) {
        document.body.style.background = `url(${settings.bgImage}) center/cover no-repeat`;
      } else if (settings.bgColor) {
        document.body.style.background = settings.bgColor;
      }

      if (settings.blurValue) {
        document.body.style.backdropFilter = `blur(${settings.blurValue}px)`;
      }

      if (settings.fontColor) {
        document.documentElement.style.setProperty('--font-color', settings.fontColor);
      }
      updateSidebarColor(settings.bgColor || '#ffffff');
    })();
  function applyUserStyle(style) {
    if(style.custom_bg && style.custom_bg !== ''){
      document.body.style.background = `url(${style.custom_bg}) center/cover`;
    } else {
      document.body.style.background = style.bg_color;
    }

    document.body.style.backdropFilter = `blur(${style.blur || 0}px)`;
    document.body.style.color = style.font_color;
  }

  applyUserStyle(userStyle);
</script>
